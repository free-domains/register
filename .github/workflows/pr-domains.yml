name: Domains

on:
    pull_request:
        paths:
            - "domains/*"

jobs:
    validate_email:
        name: Validate Email
        runs-on: ubuntu-latest

        steps:
            - uses: actions/checkout@v3

            - name: Find Modified JSON Files
              id: find_files
              run: |
                  echo "::set-output name=files::$(git diff --name-only --diff-filter=M "domains/" | grep '\.json$' || echo '')"

            - name: Retrieve and Validate Emails
              id: validate_email
              run: |
                  for file in ${{ steps.find_files.outputs.files }}; do
                      owner_email=$(jq -r '.owner.email' "$file")

                      echo "::debug::Validating email: $owner_email"
                      echo "::set-output name=email::$owner_email"
                      echo "::set-output name=file::$file"
                  done

            - name: Validate Email
              id: email_validation
              run: |
                  failed_validations=""

                  for file in ${{ steps.find_files.outputs.files }}; do
                      owner_email=$(jq -r '.owner.email' "$file")

                      echo "Validating email: $owner_email"

                      if ! email_validation_result=$(wdhdev/validate-email-action@main --email "$owner_email"); then
                          echo "::debug::FAIL $owner_email $file"
                          failed_validations="${failed_validations}FAIL $owner_email $file\n"
                      else
                          echo "::debug::PASS $owner_email $file"
                      fi
                  done

                  if [[ $failed_validations != "" ]]; then
                      echo "::error::Email validation failed for the following files:\n${failed_validations}"
                      exit 1
                  fi

                  echo "::set-output name=failed_validations::$failed_validations"

            - name: Fail Workflow on Validation Failure
              if: ${{ steps.email_validation.outputs.failed_validations != '' }}
              run: exit 1
